<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Face Attendance — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ========== Style A — Clean Dashboard ========== */
    :root{
      --bg:#f6fafc; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --primary:#0b6efd; --accent:#0b6efd; --success:#10b981; --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      --radius:12px;
      --shadow: 0 8px 30px rgba(15,23,42,0.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system,
       "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:20px;
      padding:20px 28px; background: linear-gradient(90deg, #ffffff, #f8fbff);
      border-bottom: 1px solid #eef2ff;
    }
    .brand {display:flex; gap:14px; align-items:center;}
    .logo {
      width:44px; height:44px; border-radius:10px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--primary), #5aa3ff);
      color:white; font-weight:700; box-shadow: 0 6px 18px rgba(11,110,253,0.12);
    }
    .title {font-size:16px; font-weight:600;}
    .subtitle {font-size:12px; color:var(--muted); margin-top:2px;}

    .header-actions {display:flex; gap:10px; align-items:center;}
    .btn {padding:8px 12px; border-radius:10px; border:none; background:#fff; box-shadow:none; cursor:pointer; color:var(--primary); font-weight:600; border:1px solid #e6eefc;}
    .btn.primary {background:var(--primary); color:#fff; border:none;}
    .btn.ghost {background:transparent; color:var(--muted); border:1px dashed #e6eefc;}

    main {padding:20px 28px;}
    .grid {display:grid; grid-template-columns: 420px 1fr; gap:18px;}

    .card {background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);}

    .left .card {margin-bottom:14px;}
    h2 {margin:0 0 8px 0; font-size:16px;}
    small {color:var(--muted)}

    /* Video + overlay */
    .video-frame {position:relative; border-radius:10px; overflow:hidden; background:#000;}
    video {display:block; width:100%; height:auto; transform:scaleX(-1); /* mirror */ }
    canvas {position:absolute; left:0; top:0; pointer-events:none; transform:scaleX(-1);} /* mirror overlay to match video */

    .controls {display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
    .control-row {display:flex; gap:8px; align-items:center; margin-top:8px;}
    input[type="text"]{width:100%; padding:10px; border-radius:8px; border:1px solid #eef2ff; background:#fbfdff;}

    /* Enrolled list */
    ul.students {list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px;}
    li.student {display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #f1f7ff;}
    .avatar {width:44px; height:44px; border-radius:8px; overflow:hidden; display:grid; place-items:center; background:#eef6ff;}
    .student-actions {margin-left:auto; display:flex; gap:6px;}

    /* Attendance log table */
    table {width:100%; border-collapse:collapse; font-size:13px;}
    th, td {text-align:left; padding:8px 10px; border-bottom:1px solid #f3f7ff;}
    th {background:#fbfdff; font-weight:600; color:var(--muted); font-size:12px;}
    .muted {color:var(--muted)}

    /* Tabs */
    .tabs {display:flex; gap:8px; margin-bottom:12px;}
    .tab {padding:8px 12px; background:transparent; border-radius:10px; cursor:pointer; color:var(--muted); border:1px solid transparent;}
    .tab.active {background:#eef6ff; color:var(--primary); border-color: #e6f0ff; font-weight:700;}

    /* Badge & spinner */
    .status-badge {display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; background:#fff; border:1px solid #eef6ff; box-shadow: 0 6px 18px rgba(11,110,253,0.04)}
    .dot {width:10px; height:10px; border-radius:50%;}
    .dot.green{background:var(--success)} .dot.red{background:var(--danger)} .dot.gray{background:#c7d2fe}
    .spinner {width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.06); border-top-color:var(--primary); animation:spin 1s linear infinite;}
    @keyframes spin {to{transform:rotate(360deg)}}

    /* toast */
    .toasts {position:fixed; right:20px; bottom:20px; display:flex; flex-direction:column; gap:8px; z-index:9999;}
    .toast {background:#0b6efd;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(11,110,253,0.14);font-weight:600}

    /* responsive */
    @media (max-width:980px){
      .grid {grid-template-columns:1fr; }
      header{flex-direction:column; align-items:flex-start; gap:8px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">FA</div>
      <div>
        <div class="title">Face Attendance</div>
        <div class="subtitle">Prototype</div>
      </div>
    </div>
    <div class="header-actions">
      <div class="status-badge" id="modelStatus">
        <div class="spinner" id="modelSpinner" style="display:none"></div>
        <div id="modelText">Models: not loaded</div>
      </div>
      <button class="btn ghost" id="helpBtn">Help</button>
      <button class="btn primary" id="downloadBtn">Export Data</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="left">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>Camera</h2>
            <small id="camState" class="muted">stopped</small>
          </div>

          <div class="video-frame" style="margin-top:10px;">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
          </div>

          <div class="controls">
            <button class="btn primary" id="startBtn">Start Camera</button>
            <button class="btn" id="stopBtn">Stop</button>
            <button class="btn" id="toggleLiveBtn">Live: Off</button>
            <div style="margin-left:auto">
              <label class="muted" style="font-size:12px">Threshold</label>
              <input id="thresholdRange" type="range" min="0.3" max="0.9" step="0.01" value="0.55" />
              <div style="font-size:12px;color:var(--muted)"><span id="thresholdVal">0.55</span></div>
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
            <input id="studentName" type="text" placeholder="Student name / ID" />
            <button class="btn" id="enrollBtn">Enroll</button>
          </div>

          <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn" id="takeBtn">Take Attendance</button>
            <button class="btn" id="clearLogBtn">Clear Log</button>
            <input id="importFile" type="file" accept="application/json" style="margin-left:8px" />
          </div>

          <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <div class="status-badge" title="Detection info">
              <div id="detCount" class="muted">No detection</div>
            </div>
            <div style="flex:1"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Enrolled Students</h2>
          <small>Click Delete to remove an enrollment.</small>
          <div style="margin-top:10px;">
            <ul class="students" id="studentsList"></ul>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2>Attendance</h2>
              <small>Records stored locally (localStorage). Export to save data.</small>
            </div>
            <div class="tabs" role="tablist">
              <div class="tab active" data-tab="log">Log</div>
              <div class="tab" data-tab="stats">Stats</div>
            </div>
          </div>

          <div id="tabLog" style="margin-top:12px;">
            <table id="attendanceTable">
              <thead>
                <tr><th>Student</th><th>Timestamp</th><th>Distance</th><th></th></tr>
              </thead>
              <tbody id="attendanceBody"></tbody>
            </table>
          </div>

          <div id="tabStats" style="display:none; margin-top:12px;">
            <h3>Summary</h3>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <div class="card" style="padding:12px; width:220px;">
                <div style="font-size:12px;color:var(--muted)">Total Records</div>
                <div id="statCount" style="font-size:22px;font-weight:700">0</div>
              </div>
              <div class="card" style="padding:12px; width:220px;">
                <div style="font-size:12px;color:var(--muted)">Enrolled</div>
                <div id="statEnrolled" style="font-size:22px;font-weight:700">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Controls</h2>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn" id="exportBtn">Export JSON</button>
            <button class="btn" id="importBtn">Import JSON</button>
            <button class="btn" id="eraseBtn">Erase All Data</button>
          </div>
          <div style="margin-top:10px; color:var(--muted); font-size:13px;">
            <p>Tip: Use Export to backup enrollments & attendance. For production, use secure server-side storage & authentication.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="toasts" id="toasts"></div>

  <!-- face-api.js -->
  <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
  /* ---------------------------
     Data storage utilities
     --------------------------- */
  const ENROLL_KEY = 'fa_enroll_v1';
  const ATT_KEY = 'fa_att_v1';

  function loadEnrollments(){
    const raw = localStorage.getItem(ENROLL_KEY);
    return raw ? JSON.parse(raw) : {};
  }
  function saveEnrollments(v){ localStorage.setItem(ENROLL_KEY, JSON.stringify(v)); }
  function loadAttendance(){ const raw = localStorage.getItem(ATT_KEY); return raw ? JSON.parse(raw) : []; }
  function saveAttendance(v){ localStorage.setItem(ATT_KEY, JSON.stringify(v)); }

  function descriptorToArray(d){ return Array.from(d); }
  function arrayToDescriptor(arr){ return new Float32Array(arr); }

  /* ---------------------------
     UI refs
     --------------------------- */
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const enrollBtn = document.getElementById('enrollBtn');
  const studentNameInput = document.getElementById('studentName');
  const studentsList = document.getElementById('studentsList');
  const takeBtn = document.getElementById('takeBtn');
  const thresholdRange = document.getElementById('thresholdRange');
  const thresholdVal = document.getElementById('thresholdVal');
  const matchStatus = document.getElementById('detCount');
  const modelText = document.getElementById('modelText');
  const modelSpinner = document.getElementById('modelSpinner');
  const camState = document.getElementById('camState');
  const toggleLiveBtn = document.getElementById('toggleLiveBtn');

  const attendanceBody = document.getElementById('attendanceBody');
  const statCount = document.getElementById('statCount');
  const statEnrolled = document.getElementById('statEnrolled');

  const toasts = document.getElementById('toasts');

  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const eraseBtn = document.getElementById('eraseBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const importFile = document.getElementById('importFile');

  /* ---------------------------
     Toast helper
     --------------------------- */
  function toast(msg, ms=3000){
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    toasts.appendChild(t);
    setTimeout(()=> { t.style.opacity='0'; t.style.transform='translateY(6px)'; }, ms-500);
    setTimeout(()=> t.remove(), ms);
  }

  /* ---------------------------
     FaceAPI models
     --------------------------- */
  let modelsLoaded = false;
  async function loadModels(){
    // change to '/models' if you have local copies
    const MODEL_URL = './models';
    modelSpinner.style.display = 'inline-block';
    modelText.textContent = 'Loading models...';
    try{
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      ]);
      modelsLoaded = true;
      modelSpinner.style.display = 'none';
      modelText.textContent = 'Models loaded';
      toast('Models loaded');
      console.log('models loaded from', MODEL_URL);
    }catch(err){
      modelsLoaded = false;
      modelSpinner.style.display = 'none';
      modelText.textContent = 'Model load failed';
      console.error('Model load error', err);
      toast('Model load failed — open console', 5000);
    }
  }

  /* ---------------------------
     Camera control + overlay
     --------------------------- */
  let stream = null;
  let overlayCtx = null;
  let liveMode = false;
  let liveLoopId = null;

  function ensureCanvasSize(){
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
  }

  async function startCamera(){
    if (!modelsLoaded) await loadModels();
    if (!modelsLoaded) return;
    if (stream) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
      video.srcObject = stream;
      await video.play();
      ensureCanvasSize();
      overlayCtx = overlay.getContext('2d');
      camState.textContent = 'running';
      toast('Camera started');
    }catch(err){
      console.error('Camera error', err);
      toast('Camera start failed: ' + (err.message||err.name), 5000);
    }
  }

  function stopCamera(){
    if (!stream) return;
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.pause();
    video.srcObject = null;
    overlayCtx && overlayCtx.clearRect(0,0,overlay.width, overlay.height);
    camState.textContent = 'stopped';
    toast('Camera stopped', 1200);
    if (liveLoopId) { cancelAnimationFrame(liveLoopId); liveLoopId = null; liveMode=false; toggleLiveBtn.textContent='Live: Off'; }
  }

  startBtn.onclick = startCamera;
  stopBtn.onclick = stopCamera;

  // handle resizing to match video
  window.addEventListener('resize', ()=> {
    if (video && video.videoWidth) ensureCanvasSize();
  });

  /* ---------------------------
     Enrollment
     --------------------------- */
  function refreshStudentsUI(){
    const enrolls = loadEnrollments();
    studentsList.innerHTML = '';
    const keys = Object.keys(enrolls);
    if (keys.length===0){
      studentsList.innerHTML = '<li class="muted">No enrollments yet</li>';
    } else {
      for (const id of keys){
        const e = enrolls[id];
        const li = document.createElement('li');
        li.className = 'student';
        // avatar (if stored)
        const av = document.createElement('div'); av.className='avatar';
        if (e.avatarDataUrl){
          const img = document.createElement('img'); img.src = e.avatarDataUrl; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
          av.appendChild(img);
        } else {
          av.textContent = e.name[0] || '?';
        }
        const body = document.createElement('div');
        body.innerHTML = `<div style="font-weight:700">${e.name}</div><div style="font-size:12px;color:var(--muted)">samples: ${e.descriptors.length}</div>`;
        const actions = document.createElement('div'); actions.className='student-actions';
        const del = document.createElement('button'); del.className='btn'; del.textContent='Delete';
        del.onclick = ()=> {
          if (!confirm('Delete ' + e.name + '?')) return;
          const all = loadEnrollments(); delete all[id]; saveEnrollments(all); refreshStudentsUI(); toast('Deleted ' + e.name,2000); updateStats();
        };
        actions.appendChild(del);
        li.appendChild(av); li.appendChild(body); li.appendChild(actions);
        studentsList.appendChild(li);
      }
    }
    updateStats();
  }

  function generateId(name){ return name.replace(/\s+/g,'_') + '_' + Date.now(); }

  async function enrollCurrent(){
    const name = (studentNameInput.value||'').trim();
    if (!name){ toast('Enter student name', 1800); return; }
    if (!stream){ toast('Start camera first', 2000); return; }
    try{
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
      const det = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
      if (!det){ toast('No face detected — ensure well-lit & centered', 3000); return; }
      const descArr = descriptorToArray(det.descriptor);
      const id = generateId(name);
      const enrolls = loadEnrollments();
      // capture small avatar
      ensureCanvasSize();
      const tmpCanvas = document.createElement('canvas'); tmpCanvas.width=128; tmpCanvas.height=128;
      const ctx = tmpCanvas.getContext('2d');
      // draw mirrored capture to match video mirroring
      ctx.translate(tmpCanvas.width,0); ctx.scale(-1,1);
      ctx.drawImage(video, 0, 0, tmpCanvas.width, tmpCanvas.height);
      const avatarDataUrl = tmpCanvas.toDataURL('image/jpeg',0.7);
      enrolls[id] = { name, descriptors: [descArr], avatarDataUrl, createdAt: new Date().toISOString() };
      saveEnrollments(enrolls);
      refreshStudentsUI();
      studentNameInput.value = '';
      toast('Enrolled ' + name, 2200);
    }catch(err){
      console.error('Enroll error', err);
      toast('Enroll failed — see console', 4000);
    }
  }
  enrollBtn.onclick = enrollCurrent;

  /* ---------------------------
     Matching & Attendance
     --------------------------- */
  function buildLabeled(){
    const enrolls = loadEnrollments();
    const out = [];
    Object.keys(enrolls).forEach(id=>{
      const e = enrolls[id];
      out.push({ id, name: e.name, descriptors: e.descriptors.map(arrayToDescriptor) });
    });
    return out;
  }

  function euclideanDistance(a,b){
    let s=0; for (let i=0;i<a.length;i++){ const d=a[i]-b[i]; s+=d*d; } return Math.sqrt(s);
  }

  function findBest(descriptor, labeled){
    let best = null;
    labeled.forEach(lbl=>{
      lbl.descriptors.forEach(st => {
        const dist = euclideanDistance(descriptor, st);
        if (!best || dist < best.distance) best = { id: lbl.id, name: lbl.name, distance: dist };
      });
    });
    return best;
  }

  function appendAttendance(entry){
    const arr = loadAttendance();
    arr.unshift(entry); // newest first
    saveAttendance(arr);
    renderAttendance();
  }

  async function takeAttendanceOnce(){
    if (!stream){ toast('Start camera first',2000); return; }
    try{
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
      const det = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
      if (!det){ drawOverlay(null); matchStatus.textContent='No face'; return; }
      const probe = det.descriptor;
      const labeled = buildLabeled();
      if (labeled.length===0){ toast('No enrollments — enroll first',3000); return; }
      const best = findBest(probe, labeled);
      const threshold = parseFloat(thresholdRange.value);
      if (best && best.distance <= threshold){
        const entry = { id: best.id, name: best.name, timestamp: new Date().toISOString(), distance: best.distance };
        appendAttendance(entry);
        drawOverlay(det.detection.box, best.name);
        matchStatus.textContent = `${best.name} ✓ (${best.distance.toFixed(3)})`;
        toast('Marked: ' + best.name, 1500);
      } else {
        drawOverlay(det.detection.box, 'Unknown');
        matchStatus.textContent = `Unknown (${best ? best.distance.toFixed(3) : '—'})`;
        toast('No match', 1400);
      }
    }catch(err){
      console.error('Attendance error', err);
      toast('Attendance failed — see console', 4000);
    }
  }
  takeBtn.onclick = takeAttendanceOnce;

  /* Draw overlay */
  function drawOverlay(box, label){
    if (!overlayCtx) return;
    overlayCtx.clearRect(0,0,overlay.width, overlay.height);
    if (!box) return;
    const { x, y, width, height } = box;
    overlayCtx.lineWidth = 3;
    overlayCtx.strokeStyle = 'rgba(11,110,253,0.95)';
    overlayCtx.strokeRect(x, y, width, height);
    overlayCtx.fillStyle = 'rgba(11,110,253,0.95)';
    overlayCtx.font = '18px Inter, sans-serif';
    const text = label || '';
    const textW = overlayCtx.measureText(text).width + 12;
    overlayCtx.fillRect(x, y - 30, Math.max(textW, 80), 26);
    overlayCtx.fillStyle = '#fff';
    overlayCtx.fillText(text, x + 8, y - 12);
  }

  /* ---------------------------
     Live mode loop
     --------------------------- */
  toggleLiveBtn.onclick = ()=> {
    liveMode = !liveMode;
    toggleLiveBtn.textContent = liveMode ? 'Live: On' : 'Live: Off';
    if (liveMode) startLiveLoop(); else stopLiveLoop();
  };

  function startLiveLoop(){
    if (!stream) { toast('Start camera first',2000); liveMode=false; toggleLiveBtn.textContent='Live: Off'; return; }
    let labeled = buildLabeled();
    if (labeled.length===0){ toast('No enrollments for live mode',2000); liveMode=false; toggleLiveBtn.textContent='Live: Off'; return; }
    async function loop(){
      if (!liveMode) return;
      try{
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detections = await faceapi.detectAllFaces(video, options).withFaceLandmarks().withFaceDescriptors();
        overlayCtx && overlayCtx.clearRect(0,0,overlay.width, overlay.height);
        if (detections && detections.length>0){
          matchStatus.textContent = `${detections.length} face(s)`;
          for (const det of detections){
            const best = findBest(det.descriptor, labeled);
            const threshold = parseFloat(thresholdRange.value);
            const label = (best && best.distance<=threshold) ? `${best.name} (${best.distance.toFixed(2)})` : 'Unknown';
            drawOverlay(det.detection.box, label);
            // auto-mark only if matched (and don't flood — simple debounce per name)
            if (best && best.distance<=threshold){
              // quick duplicate prevention: check last record for same name within 60s
              const arr = loadAttendance();
              const last = arr[0];
              if (!last || last.name !== best.name || (Date.now() - new Date(last.timestamp).getTime()) > 60000){
                appendAttendance({ id: best.id, name: best.name, timestamp: new Date().toISOString(), distance: best.distance });
                toast('Live marked: ' + best.name, 1600);
                labeled = buildLabeled(); // reload in case enrollments changed
              }
            }
          }
        } else {
          matchStatus.textContent = 'No faces';
        }
      }catch(err){ console.error('live loop', err); }
      liveLoopId = requestAnimationFrame(loop);
    }
    loop();
  }

  function stopLiveLoop(){
    if (liveLoopId) cancelAnimationFrame(liveLoopId);
    liveLoopId = null;
  }

  /* ---------------------------
     Render attendance & stats
     --------------------------- */
  function renderAttendance(){
    const arr = loadAttendance();
    attendanceBody.innerHTML = '';
    if (arr.length === 0){
      attendanceBody.innerHTML = '<tr><td colspan="4" class="muted">No records yet</td></tr>';
    } else {
      arr.forEach((r, i)=>{
        const tr = document.createElement('tr');
        const dt = new Date(r.timestamp);
        tr.innerHTML = `<td style="font-weight:700">${r.name}</td>
                        <td>${dt.toLocaleString()}</td>
                        <td>${r.distance ? r.distance.toFixed(3) : ''}</td>
                        <td><button class="btn" data-idx="${i}">Delete</button></td>`;
        attendanceBody.appendChild(tr);
      });
      // attach delete handlers
      attendanceBody.querySelectorAll('button').forEach(b=>{
        b.onclick = (e)=>{
          const idx = parseInt(b.getAttribute('data-idx'));
          const arr = loadAttendance();
          arr.splice(idx,1);
          saveAttendance(arr);
          renderAttendance();
          toast('Record deleted',1400);
        };
      });
    }
    updateStats();
  }

  function updateStats(){
    const arr = loadAttendance();
    statCount.textContent = arr.length;
    const enrolled = Object.keys(loadEnrollments()).length;
    statEnrolled.textContent = enrolled;
  }

  /* ---------------------------
     Export / Import / Erase
     --------------------------- */
  exportBtn.onclick = () => {
    const payload = { enrollments: loadEnrollments(), attendance: loadAttendance(), exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'face_attendance_export_' + Date.now() + '.json'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast('Exported data',1600);
  };

  downloadBtn.onclick = exportBtn.onclick;

  importBtn.onclick = ()=> importFile.click();
  importFile.onchange = async (e)=>{
    const f = e.target.files[0]; if (!f) return;
    const txt = await f.text();
    try{
      const parsed = JSON.parse(txt);
      if (parsed.enrollments) {
        const current = loadEnrollments();
        const merged = { ...current, ...parsed.enrollments };
        saveEnrollments(merged);
      }
      if (parsed.attendance){
        const currentA = loadAttendance();
        saveAttendance(parsed.attendance.concat(currentA));
      }
      refreshStudentsUI(); renderAttendance(); toast('Import complete',1800);
    }catch(err){ console.error(err); toast('Import failed',4000); }
    e.target.value='';
  };

  eraseBtn.onclick = ()=>{
    if (!confirm('Erase ALL enrollments and attendance?')) return;
    localStorage.removeItem(ENROLL_KEY); localStorage.removeItem(ATT_KEY);
    refreshStudentsUI(); renderAttendance(); toast('All data erased',1800);
  };

  /* ---------------------------
     Tabs (simple)
     --------------------------- */
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick = ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      document.getElementById('tabLog').style.display = (tab==='log') ? 'block' : 'none';
      document.getElementById('tabStats').style.display = (tab==='stats') ? 'block' : 'none';
    };
  });

  /* ---------------------------
     Misc UI
     --------------------------- */
  thresholdRange.oninput = ()=> thresholdVal.textContent = thresholdRange.value;

  // help button
  document.getElementById('helpBtn').onclick = ()=> {
    alert('Quick help:\n- Start Camera → Enroll faces → Take Attendance\n- Use Live mode to auto-mark students present.\n- Data stored in localStorage; Export to back up.');
  };

  /* ---------------------------
     Initialization
     --------------------------- */
  (function init(){
    refreshStudentsUI();
    renderAttendance();
    // do not load models until camera start to keep fast load, but we can call loadModels early
    loadModels();
    // prepare overlay canvas size once metadata ready
    video.addEventListener('loadedmetadata', ()=> {
      overlay.width = video.videoWidth; overlay.height = video.videoHeight;
      overlay.style.width = video.clientWidth + 'px'; overlay.style.height = video.clientHeight + 'px';
      overlayCtx = overlay.getContext('2d');
    });
  })();

  </script>
</body>
</html>
